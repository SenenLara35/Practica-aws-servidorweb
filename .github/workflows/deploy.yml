name: Despliegue a AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Descargar el código
    - name: Checkout del código
      uses: actions/checkout@v3

    # 2. Copiar archivos (Corregido para buscar en la carpeta 'app')
    - name: Copiar archivos al servidor
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "app/*"
        target: "/home/ec2-user/app"
        strip_components: 1

    # 3. Conectarse y Desplegar (Con limpieza de puertos incluida)
    - name: Desplegar en EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # Ir a la carpeta
          cd /home/ec2-user/app
          
          # Construir la nueva imagen
          sudo docker build -t mi-web-prod .
          
          # === LIMPIEZA DE PUERTOS (Crucial para evitar error 125) ===
          
          # 1. Matar el Nginx que creó Terraform al principio (el intruso)
          sudo docker stop mi-nginx || true
          sudo docker rm mi-nginx || true
          
          # 2. Matar contenedores viejos de despliegues anteriores
          sudo docker stop mi-web-container || true
          sudo docker rm mi-web-container || true
          
          # === ARRANQUE ===
          # Lanzar el nuevo contenedor en el puerto 80 limpio
          sudo docker run -d -p 80:80 --name mi-web-container mi-web-prod